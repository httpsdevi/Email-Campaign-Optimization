<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Email Campaign Optimization Dashboard</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Google Fonts - Inter -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <!-- Chart.js CDN for interactive charts -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@3.7.0/dist/chart.min.js"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6; /* Light gray background */
        }
        .card {
            background-color: #ffffff;
            border-radius: 0.75rem; /* rounded-xl */
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06); /* shadow-md */
            padding: 1.5rem; /* p-6 */
            transition: transform 0.2s ease-in-out;
        }
        .card:hover {
            transform: translateY(-5px);
        }
        .tab-button {
            transition: background-color 0.3s ease, color 0.3s ease;
        }
        .tab-button.active {
            background-color: #1d4ed8; /* blue-700 */
            color: white;
            border-radius: 0.75rem 0.75rem 0 0; /* rounded-t-xl */
        }
        .tab-content {
            display: none;
            opacity: 0;
            transition: opacity 0.5s ease-in-out;
        }
        .tab-content.active {
            display: block;
            opacity: 1;
        }
        /* Custom scrollbar for better UX */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 10px;
        }
        ::-webkit-scrollbar-thumb {
            background: #888;
            border-radius: 10px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #555;
        }

        /* Loading Spinner */
        .loader {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #3498db;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
            display: none; /* Hidden by default */
        }

        .loader.active {
            display: block;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="min-h-screen flex flex-col">

    <!-- Header -->
    <header class="bg-gradient-to-r from-blue-600 to-indigo-700 text-white p-6 shadow-lg">
        <div class="container mx-auto flex items-center justify-between">
            <h1 class="text-3xl font-bold">Email Campaign Dashboard</h1>
            <nav>
                <ul class="flex space-x-6">
                    <li><a href="#" class="hover:text-blue-200 transition duration-300">Overview</a></li>
                    <li><a href="#" class="hover:text-blue-200 transition duration-300">A/B Tests</a></li>
                    <li><a href="#" class="hover:text-blue-200 transition duration-300">Segments</a></li>
                    <li><a href="#" class="hover:text-blue-200 transition duration-300">Settings</a></li>
                </ul>
            </nav>
        </div>
    </header>

    <!-- Main Content Area -->
    <main class="container mx-auto p-6 flex-grow">
        <!-- Date Range Filter -->
        <div class="card mb-6 flex flex-col md:flex-row items-center justify-between gap-4">
            <h2 class="text-xl font-semibold text-gray-800">Filter Data by Date Range:</h2>
            <div class="flex flex-col md:flex-row gap-4 w-full md:w-auto">
                <div class="flex items-center gap-2">
                    <label for="startDate" class="text-gray-700">From:</label>
                    <input type="date" id="startDate" class="p-2 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500">
                </div>
                <div class="flex items-center gap-2">
                    <label for="endDate" class="text-gray-700">To:</label>
                    <input type="date" id="endDate" class="p-2 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500">
                </div>
                <button id="applyFilterBtn" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-md transition duration-300 ease-in-out transform hover:scale-105">
                    Apply Filter
                </button>
            </div>
        </div>

        <!-- Loading Indicator -->
        <div id="loadingIndicator" class="flex justify-center items-center py-8 hidden">
            <div class="loader active mr-3"></div>
            <p class="text-lg text-gray-700">Loading data, please wait...</p>
        </div>

        <div id="dashboardContent" class="hidden">
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
                <!-- KPI Cards -->
                <div class="card flex items-center justify-between">
                    <div>
                        <p class="text-gray-500 text-sm">Total Emails Sent</p>
                        <p class="text-3xl font-bold text-gray-800" id="totalEmails">0</p>
                    </div>
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-12 w-12 text-blue-500" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z" />
                    </svg>
                </div>
                <div class="card flex items-center justify-between">
                    <div>
                        <p class="text-gray-500 text-sm">Open Rate</p>
                        <p class="text-3xl font-bold text-gray-800" id="openRate">0.00%</p>
                    </div>
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-12 w-12 text-green-500" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
                        <path stroke-linecap="round" stroke-linejoin="round" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z" />
                    </svg>
                </div>
                <div class="card flex items-center justify-between">
                    <div>
                        <p class="text-gray-500 text-sm">Conversion Rate</p>
                        <p class="text-3xl font-bold text-gray-800" id="conversionRate">0.00%</p>
                    </div>
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-12 w-12 text-purple-500" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
                    </svg>
                </div>
            </div>

            <!-- Tabs for different sections -->
            <div class="bg-white rounded-xl shadow-md p-4 mb-6">
                <div class="flex border-b border-gray-200">
                    <button class="tab-button active px-6 py-3 text-lg font-medium text-gray-700 hover:bg-blue-100 transition duration-300" data-tab="overview">Overview</button>
                    <button class="tab-button px-6 py-3 text-lg font-medium text-gray-700 hover:bg-blue-100 transition duration-300" data-tab="ab-tests">A/B Tests</button>
                    <button class="tab-button px-6 py-3 text-lg font-medium text-gray-700 hover:bg-blue-100 transition duration-300" data-tab="segments">Segments</button>
                </div>

                <!-- Tab Content -->
                <div id="overview" class="tab-content active pt-4">
                    <h2 class="text-2xl font-semibold text-gray-800 mb-4">Overall Campaign Performance</h2>
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                        <div class="card">
                            <h3 class="text-xl font-medium mb-4">Open Rate by Subject Line Version</h3>
                            <canvas id="openRateChart" class="w-full h-auto rounded-lg"></canvas>
                            <p class="text-sm text-gray-500 mt-2">This chart visualizes the open rates for different subject line variations, helping identify which performs best.</p>
                        </div>
                        <div class="card">
                            <h3 class="text-xl font-medium mb-4">Conversion Rate by User Segment</h3>
                            <canvas id="conversionRateChart" class="w-full h-auto rounded-lg"></canvas>
                            <p class="text-sm text-gray-500 mt-2">Understand how different user segments respond to your campaigns by analyzing their conversion rates.</p>
                        </div>
                    </div>
                </div>

                <div id="ab-tests" class="tab-content pt-4">
                    <h2 class="text-2xl font-semibold text-gray-800 mb-4">A/B Test Results</h2>
                    <div class="card">
                        <h3 class="text-xl font-medium mb-4">Subject Line A/B Test: Conversion Rate</h3>
                        <div class="overflow-x-auto">
                            <table class="min-w-full divide-y divide-gray-200">
                                <thead class="bg-gray-50">
                                    <tr>
                                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Version</th>
                                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Emails Sent</th>
                                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Conversions</th>
                                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Conversion Rate (%)</th>
                                    </tr>
                                </thead>
                                <tbody class="bg-white divide-y divide-gray-200">
                                    <tr>
                                        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">Version A: Exciting Offer!</td>
                                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500" id="abTestSentA">0</td>
                                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500" id="abTestConversionsA">0</td>
                                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500" id="abTestRateA">0.00%</td>
                                    </tr>
                                    <tr>
                                        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">Version B: Don't Miss Out!</td>
                                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500" id="abTestSentB">0</td>
                                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500" id="abTestConversionsB">0</td>
                                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500" id="abTestRateB">0.00%</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                        <div class="mt-4 p-4 rounded-lg bg-blue-50 border border-blue-200 text-blue-800" id="abTestConclusion">
                            <p class="font-semibold">Conclusion:</p>
                            <p>Loading A/B test results...</p>
                        </div>
                    </div>
                </div>

                <div id="segments" class="tab-content pt-4">
                    <h2 class="text-2xl font-semibold text-gray-800 mb-4">Performance by User Segment</h2>
                    <div class="card">
                        <div class="overflow-x-auto">
                            <table class="min-w-full divide-y divide-gray-200">
                                <thead class="bg-gray-50">
                                    <tr>
                                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Segment</th>
                                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Emails Sent</th>
                                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Open Rate (%)</th>
                                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Click Rate (%)</th>
                                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Conversion Rate (%)</th>
                                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Revenue per Email ($)</th>
                                    </tr>
                                </thead>
                                <tbody class="bg-white divide-y divide-gray-200" id="segmentTableBody">
                                    <!-- Data will be populated by JavaScript -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- Footer -->
    <footer class="bg-gray-800 text-white p-4 text-center text-sm mt-8">
        <p>&copy; 2025 Email Campaign Optimizer. All rights reserved.</p>
    </footer>

    <script>
        // Global Chart instances
        let openRateChartInstance = null;
        let conversionRateChartInstance = null;

        document.addEventListener('DOMContentLoaded', () => {
            const tabButtons = document.querySelectorAll('.tab-button');
            const tabContents = document.querySelectorAll('.tab-content');
            const loadingIndicator = document.getElementById('loadingIndicator');
            const dashboardContent = document.getElementById('dashboardContent');
            const startDateInput = document.getElementById('startDate');
            const endDateInput = document.getElementById('endDate');
            const applyFilterBtn = document.getElementById('applyFilterBtn');

            // Set default date range (e.g., last 60 days)
            const today = new Date();
            const sixtyDaysAgo = new Date();
            sixtyDaysAgo.setDate(today.getDate() - 60);

            startDateInput.value = sixtyDaysAgo.toISOString().split('T')[0];
            endDateInput.value = today.toISOString().split('T')[0];

            // --- Tab Switching Logic ---
            tabButtons.forEach(button => {
                button.addEventListener('click', () => {
                    tabButtons.forEach(btn => btn.classList.remove('active'));
                    tabContents.forEach(content => content.classList.remove('active'));

                    button.classList.add('active');
                    const targetTab = button.dataset.tab;
                    document.getElementById(targetTab).classList.add('active');
                });
            });

            // --- Chart Initialization Functions ---
            function createOpenRateChart(labels, data) {
                const ctx = document.getElementById('openRateChart').getContext('2d');
                if (openRateChartInstance) {
                    openRateChartInstance.destroy(); // Destroy previous instance if it exists
                }
                openRateChartInstance = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: labels,
                        datasets: [{
                            label: 'Open Rate (%)',
                            data: data,
                            backgroundColor: ['rgba(59, 130, 246, 0.7)', 'rgba(79, 70, 229, 0.7)', 'rgba(251, 191, 36, 0.7)'], // blue, indigo, yellow
                            borderColor: ['rgba(59, 130, 246, 1)', 'rgba(79, 70, 229, 1)', 'rgba(251, 191, 36, 1)'],
                            borderWidth: 1,
                            borderRadius: 8,
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                display: false,
                            },
                            tooltip: {
                                callbacks: {
                                    label: function(context) {
                                        return `${context.label}: ${context.raw.toFixed(2)}%`;
                                    }
                                }
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: true,
                                title: {
                                    display: true,
                                    text: 'Open Rate (%)'
                                }
                            },
                            x: {
                                title: {
                                    display: true,
                                    text: 'Subject Line Version'
                                }
                            }
                        }
                    }
                });
            }

            function createConversionRateChart(labels, data) {
                const ctx = document.getElementById('conversionRateChart').getContext('2d');
                if (conversionRateChartInstance) {
                    conversionRateChartInstance.destroy(); // Destroy previous instance if it exists
                }
                conversionRateChartInstance = new Chart(ctx, {
                    type: 'pie',
                    data: {
                        labels: labels,
                        datasets: [{
                            label: 'Conversion Rate (%)',
                            data: data,
                            backgroundColor: [
                                'rgba(16, 185, 129, 0.7)', // green
                                'rgba(245, 158, 11, 0.7)',  // amber
                                'rgba(139, 92, 246, 0.7)',   // purple
                                'rgba(239, 68, 68, 0.7)' // red
                            ],
                            borderColor: [
                                'rgba(16, 185, 129, 1)',
                                'rgba(245, 158, 11, 1)',
                                'rgba(139, 92, 246, 1)',
                                'rgba(239, 68, 68, 1)'
                            ],
                            borderWidth: 1
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                position: 'right',
                            },
                            tooltip: {
                                callbacks: {
                                    label: function(context) {
                                        const label = context.label || '';
                                        const value = context.raw;
                                        return `${label}: ${value.toFixed(2)}%`;
                                    }
                                }
                            }
                        }
                    }
                });
            }

            // --- Data Fetching and Render Dashboard ---
            async function fetchDataAndRenderDashboard(startDate, endDate) {
                loadingIndicator.classList.remove('hidden');
                dashboardContent.classList.add('hidden');

                try {
                    // IMPORTANT: You MUST replace 'http://127.0.0.1:5000' with the actual public URL
                    // of your deployed Flask backend.
                    // Examples:
                    //   - If deployed to Heroku: 'https://your-flask-app-name.herokuapp.com'
                    //   - If deployed to Render: 'https://your-flask-app-name.onrender.com'
                    // If you are running locally, keep it as 'http://127.0.0.1:5000'.
                    const BASE_URL = 'http://127.0.0.1:5000'; // <--- **CRITICAL: CHANGE THIS FOR DEPLOYMENT**

                    // Step 1: Fetch filtered raw data from the backend
                    const dataResponse = await fetch(`${BASE_URL}/api/data?startDate=${startDate}&endDate=${endDate}`);
                    if (!dataResponse.ok) {
                        const errorText = await dataResponse.text();
                        throw new Error(`HTTP error! Status: ${dataResponse.status}. Details: ${errorText}`);
                    }
                    const filteredData = await dataResponse.json();

                    // Step 2: Send filtered data to backend for KPI calculation
                    const kpisResponse = await fetch(`${BASE_URL}/api/kpis`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ data: filteredData })
                    });
                    if (!kpisResponse.ok) {
                        const errorText = await kpisResponse.text();
                        throw new Error(`HTTP error! Status: ${kpisResponse.status}. Details: ${errorText}`);
                    }
                    const overallKPIs = await kpisResponse.json();

                    // Step 3: Send filtered data to backend for Segment Analysis
                    const segmentsResponse = await fetch(`${BASE_URL}/api/segments`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ data: filteredData })
                    });
                    if (!segmentsResponse.ok) {
                        const errorText = await segmentsResponse.text();
                        throw new Error(`HTTP error! Status: ${segmentsResponse.status}. Details: ${errorText}`);
                    }
                    const segmentData = await segmentsResponse.json();

                    // Step 4: Send filtered data to backend for A/B Test Results
                    const abTestResponse = await fetch(`${BASE_URL}/api/ab_test`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ data: filteredData })
                    });
                    if (!abTestResponse.ok) {
                        const errorText = await abTestResponse.text();
                        throw new Error(`HTTP error! Status: ${abTestResponse.status}. Details: ${errorText}`);
                    }
                    const abTestResults = await abTestResponse.json();

                    // --- Populate UI with fetched data ---

                    // Populate overall KPIs
                    document.getElementById('totalEmails').textContent = overallKPIs.TotalEmailsSent.toLocaleString();
                    document.getElementById('openRate').textContent = `${overallKPIs.OpenRate.toFixed(2)}%`;
                    document.getElementById('conversionRate').textContent = `${overallKPIs.ConversionRate.toFixed(2)}%`;

                    // Populate A/B Test Results
                    if (abTestResults && abTestResults.test_type === 'A/B Test') {
                        document.getElementById('abTestSentA').textContent = abTestResults.total_A.toLocaleString();
                        document.getElementById('abTestConversionsA').textContent = abTestResults.success_A.toLocaleString();
                        document.getElementById('abTestRateA').textContent = `${abTestResults.rate_A.toFixed(2)}%`;

                        document.getElementById('abTestSentB').textContent = abTestResults.total_B.toLocaleString();
                        document.getElementById('abTestConversionsB').textContent = abTestResults.success_B.toLocaleString();
                        document.getElementById('abTestRateB').textContent = `${abTestResults.rate_B.toFixed(2)}%`;

                        const abTestConclusionElement = document.getElementById('abTestConclusion');
                        if (abTestResults.significant) {
                            abTestConclusionElement.innerHTML = `
                                <p class="font-semibold">Conclusion:</p>
                                <p>The difference in conversion rate between '${abTestResults.version_A}' and '${abTestResults.version_B}' is statistically significant (p = ${abTestResults.p_value.toFixed(5)} < 0.05). '${abTestResults.winner}' performed better.</p>
                            `;
                            abTestConclusionElement.classList.remove('bg-blue-50', 'border-blue-200', 'text-blue-800', 'bg-yellow-50', 'border-yellow-200', 'text-yellow-800');
                            abTestConclusionElement.classList.add('bg-green-50', 'border-green-200', 'text-green-800');
                        } else {
                            abTestConclusionElement.innerHTML = `
                                <p class="font-semibold">Conclusion:</p>
                                <p>The difference in conversion rate between '${abTestResults.version_A}' and '${abTestResults.version_B}' is NOT statistically significant (p = ${abTestResults.p_value.toFixed(5)} >= 0.05). More data or a larger effect size might be needed.</p>
                            `;
                            abTestConclusionElement.classList.remove('bg-green-50', 'border-green-200', 'text-green-800', 'bg-blue-50', 'border-blue-200', 'text-blue-800');
                            abTestConclusionElement.classList.add('bg-yellow-50', 'border-yellow-200', 'text-yellow-800');
                        }
                    } else {
                        document.getElementById('abTestSentA').textContent = 'N/A';
                        document.getElementById('abTestConversionsA').textContent = 'N/A';
                        document.getElementById('abTestRateA').textContent = 'N/A';
                        document.getElementById('abTestSentB').textContent = 'N/A';
                        document.getElementById('abTestConversionsB').textContent = 'N/A';
                        document.getElementById('abTestRateB').textContent = 'N/A';
                        document.getElementById('abTestConclusion').innerHTML = `<p class="font-semibold">Conclusion:</p><p>A/B test could not be performed with available data or versions.</p>`;
                        document.getElementById('abTestConclusion').classList.remove('bg-green-50', 'border-green-200', 'text-green-800', 'bg-blue-50', 'border-blue-200', 'text-blue-800');
                        document.getElementById('abTestConclusion').classList.add('bg-gray-50', 'border-gray-200', 'text-gray-800');
                    }


                    // Populate Segment Data
                    const segmentTableBody = document.getElementById('segmentTableBody');
                    segmentTableBody.innerHTML = ''; // Clear existing rows
                    if (segmentData && segmentData.length > 0) {
                        segmentData.forEach(segment => {
                            const row = `
                                <tr>
                                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${segment.segment}</td>
                                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${segment.total_sent.toLocaleString()}</td>
                                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${segment.open_rate.toFixed(2)}</td>
                                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${segment.click_rate.toFixed(2)}</td>
                                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${segment.conversion_rate.toFixed(2)}</td>
                                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${segment.revenue_per_email.toFixed(2)}</td>
                                </tr>
                            `;
                            segmentTableBody.insertAdjacentHTML('beforeend', row);
                        });
                    } else {
                         segmentTableBody.innerHTML = `<tr><td colspan="6" class="px-6 py-4 text-center text-gray-500">No segment data available for this period.</td></tr>`;
                    }


                    // Update Charts with fetched data
                    // For Open Rate Chart: Need to extract labels and data for subject line versions from filteredData
                    const subjectLineOpenRates = filteredData.reduce((acc, email) => {
                        if (!acc[email.subject_line_version]) {
                            acc[email.subject_line_version] = { opened: 0, total: 0 };
                        }
                        acc[email.subject_line_version].total++;
                        if (email.opened) {
                            acc[email.subject_line_version].opened++;
                        }
                        return acc;
                    }, {});

                    const openRateLabels = Object.keys(subjectLineOpenRates);
                    const openRateData = openRateLabels.map(label => {
                        const { opened, total } = subjectLineOpenRates[label];
                        return total > 0 ? (opened / total) * 100 : 0;
                    });
                    createOpenRateChart(openRateLabels, openRateData);


                    // For Conversion Rate Chart: Use segmentData directly
                    const conversionRateLabels = segmentData.map(s => s.segment);
                    const conversionRateValues = segmentData.map(s => s.conversion_rate);
                    createConversionRateChart(conversionRateLabels, conversionRateValues);

                } catch (error) {
                    console.error("Failed to fetch data:", error);
                    // Display a more informative error message to the user
                    dashboardContent.innerHTML = `<div class="p-4 bg-red-100 border border-red-400 text-red-700 rounded-md">
                                                    <p class="font-bold">Error loading data:</p>
                                                    <p>A network error occurred: ${error.message}.</p>
                                                    <p>This usually means the backend server is not running or is not accessible from where this page is hosted.</p>
                                                    <p>Please ensure:</p>
                                                    <ul class="list-disc list-inside ml-4">
                                                        <li>Your Flask backend (`app.py`) is running on a server.</li>
                                                        <li>The <code>BASE_URL</code> variable in this <code>index.html</code> file (around line 874) is correctly set to the public URL of your deployed Flask backend.</li>
                                                        <li>There are no firewall or network issues blocking access to the backend.</li>
                                                    </ul>
                                                  </div>`;
                } finally {
                    loadingIndicator.classList.add('hidden');
                    dashboardContent.classList.remove('hidden');
                }
            }

            // Initial data load
            fetchDataAndRenderDashboard(startDateInput.value, endDateInput.value);

            // Event listener for apply filter button
            applyFilterBtn.addEventListener('click', () => {
                fetchDataAndRenderDashboard(startDateInput.value, endDateInput.value);
            });
        });
    </script>
</body>
</html>
